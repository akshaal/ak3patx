
#include <avr/io.h>

// 16Mhz, that's external oscillator on Mega 2560.
// This doesn't configure it here, it just tells to our build system
// what we is actually using! Configuration is done using fuses (see flash-avr-fuses).
// Actual value might be a different one, one can actually measure it to provide
// some kind of accuracy (calibration) if needed.
X_CPU$(cpu_freq = 16000000);

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// PINS

// For safety reasons we set unused pins to read with pull up

X_UNUSED_PIN$(D3); // 1 PD3
X_UNUSED_PIN$(D4); // 2 PD4
// .................. 3 GND
// .................. 4 VCC
// .................. 5 GND
// .................. 6 VCC
// .................. 7 XT1
// .................. 8 XT2
X_UNUSED_PIN$(D5); // 9 PD5
X_UNUSED_PIN$(D6); // 10 PD6
X_UNUSED_PIN$(D7); // 11 PD7
X_UNUSED_PIN$(B0); // 12 PB0
X_UNUSED_PIN$(B1); // 13 PB1
X_UNUSED_PIN$(B2); // 14 PB2
X_UNUSED_PIN$(B3); // 15 PB3, MOSI
X_UNUSED_PIN$(B4); // 16 PB4, MISO
X_UNUSED_PIN$(D2); // 32 PD2
X_UNUSED_PIN$(D1); // 31 PD1, TxD TODO: Connect to rasp
X_UNUSED_PIN$(D0); // 30 PD0, RxD TODO: Connect to rasp
// .................. 29 Reset
X_UNUSED_PIN$(C5); // 28 PC5, ADC5
X_UNUSED_PIN$(C4); // 27 PC4, ADC4
X_UNUSED_PIN$(C3); // 26 PC3, ADC3
X_UNUSED_PIN$(C2); // 25 PC2, ADC2
X_UNUSED_PIN$(C1); // 24 PC1, ADC1
X_UNUSED_PIN$(C0); // 23 PC0, ADC0
X_UNUSED_PIN$(C7); // 22 PC7, ADC7
// .................. 21 AGND
// .................. 20 AREF
X_UNUSED_PIN$(C6); // 19 PC6, ADC6
// .................. 18 AVCC
// B5 - blue led .... 17 PB5, SCK

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// Timers

// 16-bit Timer1 is used for 'X_EVERY_DECISECOND$'


////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// Led pins

X_GPIO_OUTPUT$(blue_led, B5);


////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// Watchdog

X_WATCHDOG$(8s);

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// Activity indication

// This piece of code will be executed in akat event/thread loop every 1/10 second.
// We use to turn the blue led ON and OFF
X_EVERY_DECISECOND$(activity_led) {
    STATIC_VAR$(u8 state);

    blue_led.set(state);
    state = !state;
}


////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
// Main

X_MAIN$() {
    // Enable interrupts
    sei();
}
